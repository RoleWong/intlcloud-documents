## CLS Add-ons Overview

The CLS add-ons are deployed by CLS on each standard node in your cluster when you enable CLS in TKE. They are used to collect application logs generated by TKE and write them to consumers in Tencent Cloud, including CLS and Kafka.

The CLS add-ons are as follows:

| Name | Resource Type | Description |
|---------|---------|---------|
| tke-log-agent | DeamonSet | Each log-agent Pod contains a controller container and a loglistener sidecar container, which are responsible for collecting logs generated by all containers on the node. |
| cls-provisioner | Deployment | There is one instance per cluster, responsible for converting the CRD configuration into a collection configuration comprehensible by the loglistener to communicate with CLS. |
| logconfigs.cls.cloud.tencent.com | CRD | - |

 

## log-agent Release Notes

#### v1.1.7
<table>
<thead>
<tr>
<th width=20%>Category</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<th>Feature</th>
<td>
<li>Added the `logConfig-max-threshold` parameter. When the logconfig reaches the threshold, the informer is used to query the workload information after you upgrade or restart the add-on.</li>
<li>Optimized the method to obtain docker root. You can obtain it via the API preferentially.</li>
<li>Custom metadata is available to kafka collector, and SASL authentication is supported.</li>
</td>
</tr>
<tr>
<th>Bugfix</th>
<td>
<li>Fixed the problem where a kubelet parameter error occurred when starting the log-agent.</li>
<li>Fixed the problem where a logset API calling error occurred when replacing the `topicID`.</li>
<li>CLS is not case-sensitive. Fixed the case-sensitive issue of cls-provisioner.</li>
<li>The log-agent supports CSI by default. The Provisioner of StorageClasses is no longer judged and compared separately.</li>
</td>
</tr>
</tbody></table>


#### v1.1.6
<table>
<thead>
<tr>
<th width=20%>Category</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<th>Feature</th>
<td>
<li>Added multi-line Regex matching with container standard output for the kafka collector.</li>
<li>You can configure tag API address through environment variables.</li></td>
</tr>
<tr>
<th>Bugfix</th>
<td>
<li>Fixed the problem that the agent automatically created a topic but failed to sync it to the cluster tag in regions where CLS was not available, such as Shenzhen and Tianjin.</li>
<li>Fixed the problem where the kafka collector’s metadata prefix captured the format issue of containerd.</li>
<li>Fixed the problem where the incremental and full options were missing when cls-provisionert was synced to CLS.</li>
<li>You can query the workload information through informer during logconfig loading to reduce the load on apiserver.</li>
</td>
</tr>
</tbody></table>


#### v1.1.5
<table>
<thead>
<tr>
<th width=20%>Category</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<th>Feature</th>
<td>Added São Paulo and Shanghai Auto-Driving Cloud Zone that can be shipped to by CLS.</td>
</tr>
<tr>
<th>Bugfix</th>
<td>-</td>
</tr>
</tbody></table>

#### v1.1.4
<table>
<thead>
<tr>
<th width=20%>Category</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<th>Feature</th>
<td>
<li>Supported collecting standard output logs of the init container.</li>
<li>Supported the GBK encoding format for CLS log parsing.</li>
<li>Supported namespace label selectors for CLS log collection rules.</li>
</td>
</tr>
<tr>
<th>Bugfix</th>
<td>
<li>Fixed the issue of frequent retries of the event queue.</li>
<li>Optimized the queue processing algorithm for the LogConfig and Pod in the log-agent to prevent the queue from being blocked by a large number of repeated events.</li>
<li>Fixed the issue where the standard output logs of the container were not collected when there were only namespaces but no labels.</li>
</td>
</tr>
</tbody></table>

#### v1.1.3
<table>
<thead>
<tr>
<th width=20%>Category</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<th>Feature</th>
<td>
Supported index settings for CLS STANDARD_IA.
</td>
</tr>
<tr>
<th>Bugfix</th>
<td>-</td>
</tr>
</tbody></table>

#### v1.1.2
<table>
<thead>
<tr>
<th width=20%>Category</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<th>Feature</th>
<td>
 Supported configuring a blocklist in CLS collection rules for container files and host files.
</td>
</tr>
<tr>
<th>Bugfix</th>
<td>-</td>
</tr>
</tbody></table>

#### v1.1.1
<table>
<thead>
<tr>
<th width=20%>Category</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<th>Feature</th>
<td>
<li>Supported the multi-core CPU for the LogListener.</li>
<li>Adapted the LogListener memory to the upper limit of 100 MB memory.</li>
</td>
</tr>
<tr>
<th>Bugfix</th>
<td>
Fixed the issue where the log-agent failed to update the volume link and did not retry after the returned error was not processed during the update.
</td>
</tr>
</tbody></table>

#### v1.1.0
<table>
<thead>
<tr>
<th width=20%>Category</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<th>Feature</th>
<td>
<li>Supported inheriting TKE clusters' tags when a topic was automatically created by CLS.</li>
<li>Supported cross-region log shipping for CLS.</li>
</td>
</tr>
<tr>
<th>Bugfix</th>
<td>-</td>
</tr>
</tbody></table>



#### v1.0.9
<table>
<thead>
<tr>
<th width=20%>Category</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<th>Feature</th>
<td>-</td>
</tr>
<tr>
<th>Bugfix</th>
<td>
<li>Fixed the issue where an empty topic ID caused the logconfig to be deleted and recreated during topic replacement.</li>
<li>Fixed the issue where the logconfigpro sync crashed as the logconfigpro informer was not started.</li>
</td>
</tr>
</tbody></table>

#### v1.0.8

<table>
<thead>
<tr>
<th width=20%>Category</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<th>Feature</th>
<td><li>Blocked the collection of loglistener logs under kube-system by default.
</li><li>Modified the index creation policy, so that the default index was created only when a topic was automatically created, and the topic index was not modified in other scenarios.
</li><li>Supported the Kafka collector to add metadata information to messages.
</li><li>Supported the following parsing modes in the Kafka collector: full text in a single line, JSON, and full text in multiple lines.</li></td>
</tr>
<tr>
<th>Bugfix</th>
<td><li>Fixed the issue where the container couldn't be specified when collecting the standard output in the workload scenario.
</li><li>Added the docker client to get Storage Driver, so that if there was no configuration file, the `info` information could be obtained through the client to get Storage Driver.
</li><li>Fixed the error of the specified metadatalabel when collecting container files.
</li><li>Fixed the scheme to get the kubelet root directory.
</li><li>Fixed the collection configuration match error caused by the incorrectly set prefix of the old collection configuration to be deleted.
</li><li>Fixed the issue where the `timestampKey` timestamp set for messages in the current Kafka collector was invalid. </li>
</td>
</tr>
</tbody></table>

#### v1.0.7

<table>
<thead>
<tr>
<th width=20%>Category</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<th>Feature</th>
<td><li>Supported creating key-value indexes during topic creation by cls-provisioner, including index name, type, word segmentation, and statistics collection status switch; if not supported, the `pod_name,namespace,container_name` index would be enabled by default. </li><li>Supported specifying metadatalabels to write the specified Pod labels into metadata collection; if not supported, all Pod labels would be collected as metadata. </li><li>Supported customizing the CLS TencentCloud API service backend address.</li></td>
</tr>
<tr>
<th>Bugfix</th>
<td>-</td>
</tr>
</tbody></table>



#### V1.0.6

<table>
<thead>
<tr>
<th width=20%>Category</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<th>Feature</th>
<td>Supported modifying the kubelet root directory and docker root directory in log-agent.</td>
</tr>
<tr>
<th>Bugfix</th>
<td>-</td>
</tr>
</tbody></table>
 

#### v1.0.5

<table>
<thead>
<tr>
<th width=20%>Category</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<th>Feature</th>
<td><li>Supported the <code>label !=</code> operation (exclude labels) in the log collection configuration. </li><li>Supported collecting only incremental logs by CLS. </li><li>Supported selecting multiple namespaces and excluding namespaces in the log collection configuration. </li><li>Supported configuring Pod labels with the same key but different values in log-agent. </li><li>Supported configuring loglistener parameters.</li></td>
</tr>
<tr>
<th>Bugfix</th>
<td></li><li>Fixed a known issue with log-agent using configmap as source. </li><li>Fixed an issue where the collector configuration was empty and caused verification failures under some conditions. </li><li>Fixed the issue where the collector failed to delete the configuration when deleting the log rule. </li><li>Fixed compatibility issues with logConfig configuration.</li></td>
</tr>
</tbody></table>




#### v1.0.1

<table>
<thead>
<tr>
<th width=20%>Category</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<th>Feature</th>
<td><li>Switched the API for cls-provisioner to access CLS to TencentCloud API. </li><li>Supported TKE log collection and delivery to CKafka (for more information, see <a href="https://intl.cloud.tencent.com/document/product/457/32419">Configure Log Collection via the Console</a>).</li></td>
</tr>
<tr>
<th>Bugfix</th>
<td>-</td>
</tr>
</tbody></table>


#### v0.2.28

<table>
<thead>
<tr>
<th width=20%>Category</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<th>Feature</th>
<td>-</td>
</tr>
<tr>
<th>Bugfix</th>
<td>Fixed the issue where one Pod corresponded to multiple logconfig files.</td>
</tr>
</tbody></table>

 
#### v0.2.27

<table>
<thead>
<tr>
<th width=20%>Category</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<th>Feature</th>
<td>-</td>
</tr>
<tr>
<th>Bugfix</th>
<td>Fixed the issue where the extraction mode configured on a topic was overwritten in some scenarios.</td>
</tr>
</tbody></table>
 
#### v0.2.26

<table>
<thead>
<tr>
<th width=20%>Category</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<th>Feature</th>
<td>-</td>
</tr>
<tr>
<th>Bugfix</th>
<td>Fixed the issue where the metadata couldn't be created in some cases when the collection configuration of the `stdout` type was deleted.
</td>
</tr>
</tbody></table>



#### v0.2.25

<table>
<thead>
<tr>
<th width=20%>Category</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<th>Feature</th>
<td>-</td>
</tr>
<tr>
<th>Bugfix</th>
<td><li>Fixed the log-agent panic issue in some cases.
</li><li>Fixed the issue of soft connection deletion caused by workload cache.
</li><li>Fixed the metadata file creation failure.</li></td>
</tr>
</tbody></table>
 
#### v0.2.24

<table>
<thead>
<tr>
<th width=20%>Category</th>
<th>Content</th>
</tr>
</thead>
<tbody><tr>
<th>Feature</th>
<td>-</td>
</tr>
<tr>
<th>Bugfix</th>
<td><li>Fixed the issue where metadata was accidentally deleted during container restart in a Pod. </li><li>Supported automatically cleaning up <code>LogAgentRootDir</code> before log-agent start so as to avoid dirty data. </li><li>Fixed the panic of log-agent caused by extreme scenarios. </li><li>Fixed the startup failure caused by log-agent's repeated mounting of the `/data` directory.</li></td>
</tr>
</tbody></table> 




