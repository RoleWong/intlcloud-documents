## 소개

콘텐츠 조정 기능은 규정 위반 파일을 자동으로 차단합니다. 그러나 이 기능은 Cloud Object Storage(COS) 원본에 저장된 데이터에만 적용 가능하며, CDN 노드에 캐시된 데이터는 즉시 처리할 수 없습니다.

본문에서는 SCF 및 API Gateway를 통해 CDN에 캐시된 규정 위반 데이터를 즉시 차단하는 방법을 설명합니다.

## 작업 단계

1. [SCF 콘솔](https://console.cloud.tencent.com/scf/list)에 로그인하여 **함수**를 선택한 후 **생성**을 클릭하여 함수를 생성합니다.
2. **처음부터 시작하기**를 선택하고 다음 기본 구성 항목을 설정합니다.

 - 함수 유형: **이벤트 트리거 함수**를 선택합니다.
 - 함수 이름: 사용자 정의 함수 이름을 입력합니다.
 - 리전: 조정 기능이 활성화된 버킷의 리전을 선택합니다.
 - 런타임 환경: **Python 2.7**을 선택합니다.
3. 함수 코드를 다음과 같이 구성합니다.
 - 제출 방법: **로컬 zip 파일** 또는 **cos를 통해 zip 팩 업로드**를 선택합니다. zip 패키지는 [여기](https://cos5.cloud.tencent.com/cosbrowser/code/scf/cos_audit_cdn_refresh.zip)에서 다운로드할 수 있습니다.
 - 실행: index.main_handler를 입력합니다.
4. **고급 구성**을 클릭하여 **환경 구성**을 구성합니다. 필요에 따라 환경 변수를 제외한 모든 구성 항목을 수정할 수 있습니다.
 - 리소스 유형: CPU
 - 메모리: 512MB
 - 초기화 시간 초과 기간: 65
 - 실행 제한 시간: 30
 - 환경 변수:
    - CI_AUDITING_CALLBACK: 여기에 콘텐츠 조정의 콜백 설정에서 구성한 콜백 주소를 입력합니다. 콜백 주소가 설정된 경우에만 콜백이 수행됩니다.
    - CDN_URL: CDN 캐시를 제거하기 위해 필요한 CDN 주소를 설정합니다.
    - REGION: bucket이 상주하는 필수 리전을 설정합니다.
    - BUCKET_ID: 이미지 스타일을 조회하는 데 사용되는 필요한 버킷 ID(즉, 버킷 이름)를 설정합니다. 잘못된 값을 입력하면 스타일 쿼리 중에 오류가 발생합니다.
    - IMAGE_STYLE_SEPARATORS: 이미지 스타일을 제거하려면 이미지 스타일 세퍼레이터를 설정합니다. 여러 개의 세퍼레이터를 구분할 필요 없이 연속적으로 입력할 수 있습니다.
    - CDN_REFRESH_TYPE: 기본적으로 url에 의해 제거되는(즉, 스타일만 제거되는) 이미지 객체 캐시 제거 방법을 설정합니다. 이 변수를 **path**로 설정하면 이미지 처리 매개변수가 액세스하는 캐시가 제거됩니다. path로 제거하면 이 파일 이름이 포함된 파일 이름이 더 긴 파일이 제거됩니다.
캐시 제거가 예상대로 작동할 수 있도록 위의 환경 변수를 올바르게 구성해야 합니다.

5. 권한 구성에 대해 **실행 역할**을 선택하고 **실행 역할 생성**을 클릭하여 **사용자 지정 역할 생성** 페이지로 들어갑니다.
6. **scf**를 역할 엔터티로 선택하고 **다음**을 클릭합니다.

7. QcloudCDNFullAccess 및 QcloudCIReadOnlyAccess 역할 정책을 선택하고 **다음**을 클릭합니다.
8. 역할 이름을 지정하고 **완료**를 클릭합니다.
9. 사용자 지정 역할을 생성한 후 함수 생성 페이지로 돌아가서 역할 드롭다운 목록을 새로고침하고 새로 생성된 역할을 선택합니다.
10. **완료**를 클릭합니다.
11. [API Gateway 콘솔](https://console.cloud.tencent.com/apigateway/service)로 이동하여 API Gateway 서비스를 활성화합니다.
12. [Creating APIs Connecting to the SCF Backend](https://intl.cloud.tencent.com/document/product/628/39486)의 지침에 따라 API 게이트웨이를 생성합니다.
13. 릴리스 환경에 대해 **배포**를 선택하고 **서비스 배포**를 클릭합니다.
14. CI 콘솔의 **콘텐츠 조정** 페이지에서 이미지 또는 기타 대상 유형에 대한 콜백 매개변수를 설정하고 이전 단계에서 생성한 API 게이트웨이의 주소를 콜백 URL로 설정합니다.
15. 콜백이 구성되면 조정 콜백 결과에 따라 CDN의 리소스 캐시가 자동으로 제거됩니다.
